#!/usr/bin/env bash

function closest_config {
  local pth_config="${AWS_CONFIG_FILE:-${BOARD_PATH}/.aws/config}"
  pushd ./$(git rev-parse --show-cdup) >/dev/null
  if [[ -f .aws/config ]]; then
    pth_config=$(pwd)/.aws/config
  fi
  popd >/dev/null

  export AWS_CONFIG_FILE="${pth_config}"
}

function main {
  closest_config

  case "${1:-}" in
    login|assume|logout)
      local nm_cmd="$1"; shift
      exec fogg "$nm_cmd" "${BASH_SOURCE##*/}" "$@"
      ;;
    code)
      shift # code
      op assume "$(cat "${AWS_CONFIG_FILE%/config}/assume" | jq -r --arg org "${BASH_SOURCE##*/}" '.[$org].op')" imma totp "$(cat "${AWS_CONFIG_FILE%/config}/assume" | jq -r --arg org "${BASH_SOURCE##*/}" '.[$org].mfa')"
      ;;
    *)
      if [[ "$#" == 0 ]]; then
        exec fogg assume "${BASH_SOURCE##*/}" "$@"
      else
        exec fogg env "${BASH_SOURCE##*/}" "$@"
      fi
      ;;
  esac
}

unset AWS_VAULT
source sub-chain imma "$@"
